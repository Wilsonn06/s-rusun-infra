name: CD - Deploy to Local Cluster (slave6/8/9)

on:
  repository_dispatch:
    types: [image-update-local]

jobs:
  update-manifests-local:
    runs-on: self-hosted

    steps:
      - name: Extract payload
        run: |
          echo "SERVICE=${{ github.event.client_payload.service }}" >> $GITHUB_ENV
          echo "IMAGE=${{ github.event.client_payload.image }}" >> $GITHUB_ENV

      - name: Checkout infra repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.REPO_PAT_INFRA }}

      - name: Show context
        run: |
          echo "LOCAL | SERVICE = ${SERVICE}"
          echo "LOCAL | IMAGE   = ${IMAGE}"
          kubectl config current-context || echo "No kubeconfig?"

      - name: Sync with remote main
        run: |
          echo "Syncing main..."
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          git pull --rebase

      - name: Update deployment image for LOCAL
        run: |
          SERVICE="${SERVICE}"
          IMAGE="${IMAGE}"
          DEPLOYMENT_FILE="local/${SERVICE}/deployment.yaml"

          echo "Updating image in $DEPLOYMENT_FILE"
          sed -i "s|image: .*|image: ${IMAGE}|g" "$DEPLOYMENT_FILE"

          echo "--- Updated deployment.yaml ---"
          cat "$DEPLOYMENT_FILE"

      - name: Commit updated manifests (Local)
        run: |
          SERVICE="${SERVICE}"
          IMAGE="${IMAGE}"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add "local/${SERVICE}/deployment.yaml"
          git commit -m "Update LOCAL image for $SERVICE â†’ $IMAGE" || echo "No changes to commit"
          git push origin main

      - name: Apply manifests to local cluster
        run: |
          SERVICE="${SERVICE}"
          BASE_DIR="local/${SERVICE}"

          kubectl apply -f "${BASE_DIR}/deployment.yaml"
          kubectl apply -f "${BASE_DIR}/service.yaml"

      - name: Wait for rollout to complete
        run: |
          SERVICE="${SERVICE}"
          echo "Waiting rollout for deployment/${SERVICE}"
          kubectl rollout status deployment/${SERVICE} --timeout=180s

      - name: Show pods and service
        run: |
          kubectl get pods -o wide
          SERVICE="${SERVICE}"
          kubectl get svc ${SERVICE} -o wide || true
