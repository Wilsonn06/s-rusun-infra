name: CD - Deploy to Local Cluster (slave6/8/9)

on:
  repository_dispatch:
    types: [image-update-local]

jobs:
  deploy-local:
    runs-on: self-hosted

    steps:
      - name: Extract payload
        run: |
          echo "SERVICE=${{ github.event.client_payload.service }}" >> $GITHUB_ENV
          echo "IMAGE=${{ github.event.client_payload.image }}" >> $GITHUB_ENV

      - name: Checkout infra repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.REPO_PAT_INFRA }}

      - name: Show context
        run: |
          echo "Service: ${SERVICE}"
          echo "Image:   ${IMAGE}"
          kubectl config current-context || echo "No kubeconfig?"

      - name: Update deployment image
        run: |
          SERVICE="${SERVICE}"
          IMAGE="${IMAGE}"
          DEPLOYMENT_FILE="local/${SERVICE}/deployment.yaml"

          echo "Updating image tag in $DEPLOYMENT_FILE"
          
          # Replace baris image: ...
          sed -i "s|image: .*|image: ${IMAGE}|g" "$DEPLOYMENT_FILE"

          echo "--- Deployment file updated ---"
          cat "$DEPLOYMENT_FILE"

      - name: Apply manifests to local cluster
        run: |
          SERVICE="${SERVICE}"
          BASE_DIR="local/${SERVICE}"

          kubectl apply -f "${BASE_DIR}/deployment.yaml"
          kubectl apply -f "${BASE_DIR}/service.yaml"

      - name: Wait for rollout to complete
        run: |
          SERVICE="${SERVICE}"
          echo "Waiting rollout for deployment/${SERVICE}"
          kubectl rollout status deployment/${SERVICE} --timeout=180s

      - name: Show pods and service
        run: |
          kubectl get pods -o wide
          SERVICE="${SERVICE}"
          kubectl get svc ${SERVICE} -o wide || true
