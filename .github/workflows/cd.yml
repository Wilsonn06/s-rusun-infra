name: CD - Deploy to On-Prem

on:
  repository_dispatch:
    types: [image-update]

jobs:
  update-manifests-onprem:
    runs-on: ubuntu-latest
    if: github.event.action == 'image-update'

    steps:
      - name: Checkout infra repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.REPO_PAT_INFRA }}

      - name: Update deployment image for On-Prem
        run: |
          SERVICE="${{ github.event.client_payload.service }}"
          IMAGE="${{ github.event.client_payload.image }}"

          echo "ON-PREM | SERVICE = $SERVICE"
          echo "ON-PREM | IMAGE   = $IMAGE"

          DEPLOYMENT_FILE="k8s/${SERVICE}/deployment.yaml"

          echo "Updating image in $DEPLOYMENT_FILE (On-Prem)"

          sed -i "s|image: .*|image: ${IMAGE}|g" "$DEPLOYMENT_FILE"

      - name: Commit updated manifests (On-Prem)
        run: |
          SERVICE="${{ github.event.client_payload.service }}"
          IMAGE="${{ github.event.client_payload.image }}"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add "k8s/${SERVICE}/deployment.yaml"
          git commit -m "Update on-prem image for $SERVICE â†’ $IMAGE" || echo "No changes to commit"
          git push
