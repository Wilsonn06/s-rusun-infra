name: CD - Deploy to On-Prem & GKE

on:
  repository_dispatch:
    types: [image-update, image-update-gke]

jobs:
  update-manifests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout infra repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.REPO_PAT_INFRA }}

      - name: Update deployment image
        run: |
          SERVICE="${{ github.event.client_payload.service }}"
          IMAGE="${{ github.event.client_payload.image }}"

          echo "SERVICE = $SERVICE"
          echo "IMAGE   = $IMAGE"

          DEPLOYMENT_FILE="k8s/${SERVICE}/deployment.yaml"

          echo "Updating image in $DEPLOYMENT_FILE"

          sed -i "s|image: .*|image: ${IMAGE}|g" "$DEPLOYMENT_FILE"

      - name: Commit updated manifests
        run: |
          SERVICE="${{ github.event.client_payload.service }}"
          IMAGE="${{ github.event.client_payload.image }}"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add "k8s/${SERVICE}/deployment.yaml"
          git commit -m "Update image for $SERVICE → $IMAGE" || echo "No changes to commit"
          git push

  # ❌ On-prem deploy di-nonaktifkan karena cluster Docker Desktop
  #    tidak bisa diakses dari GitHub Actions.
  #    Sync ke cluster kamu lakukan manual dari laptop dengan:
  #    kubectl apply -f k8s/<service>/
  # deploy-onprem:
  #   needs: update-manifests
  #   runs-on: ubuntu-latest
  #   if: github.event.action == 'image-update'
  #
  #   steps:
  #     - name: Checkout infra repository
  #       uses: actions/checkout@v3
  #
  #     - name: Configure Kubeconfig for on-prem
  #       run: |
  #         mkdir -p ~/.kube
  #         echo "${{ secrets.KUBECONFIG_ONPREM }}" > ~/.kube/config
  #
  #     - name: Apply manifests to On-Prem Cluster
  #       run: |
  #         SERVICE="${{ github.event.client_payload.service }}"
  #         kubectl apply -f "k8s/$SERVICE/"

  deploy-gke:
    needs: update-manifests
    runs-on: ubuntu-latest
    if: github.event.action == 'image-update-gke'

    steps:
      - name: Checkout infra repository
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_LOCATION }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Apply manifests to GKE Cluster
        run: |
          SERVICE="${{ github.event.client_payload.service }}"
          kubectl apply -f "gke/$SERVICE/"
